<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pull Requests</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-light">
    <div class="container py-4">
        <h1 class="mb-4">Open Pull Requests</h1>

        <!-- PR List View -->
        <div id="pr-list" class="list-group">
            <!-- Dynamic PRs go here -->
        </div>

        <!-- PR Detail View -->
        <div id="pr-detail" class="d-none">
            <button class="btn btn-link mb-3" onclick="showListView()">&larr; Back to List</button>

            <div class="card">
                <div class="card-body">
                    <h4 id="detail-title" class="card-title"></h4>
                    <p id="detail-meta" class="text-muted"></p>
                    <p><a id="detail-giturl" href="#" class="link-underline-dark"></a></p>

                    <h5 class="mt-4">Review:</h5>
                    <div id="detail-review" class="border p-3 bg-white" style="min-height: 150px;"></div>

                    <div class="mt-4">
                        <h6>Rate the Review:</h6>
                        <button class="btn btn-outline-success me-2" onclick="sendFeedback('up')">👍 Thumbs Up</button>
                        <button class="btn btn-outline-danger" onclick="sendFeedback('down')">👎 Thumbs Down</button>
                    </div>

                    <div class="mt-4">
                        <h6>Action:</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="reviewAction" id="approve" value="Approve">
                            <label class="form-check-label" for="approve">Approve</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="reviewAction" id="requestChanges" value="Request Changes">
                            <label class="form-check-label" for="requestChanges">Request Changes</label>
                        </div>
                    </div>

                    <button class="btn btn-primary mt-3" onclick="submitReviewAction()">Submit</button>
                </div>
            </div>
        </div>
    </div>

    <script>
let prList = [];
let currentPr = null;

async function fetchPrs() {
    const response = await fetch('/api/pr');
    prList = await response.json();
    renderPrList();
}

function renderPrList() {
    const list = document.getElementById('pr-list');
    list.innerHTML = '';
    prList.forEach(pr => {
        const item = document.createElement('button');
        item.className = 'list-group-item list-group-item-action';
        item.innerHTML = `
            <strong>${pr.title}</strong><br>
            <small>#${pr.id} opened on ${pr.date || 'Unknown'} by ${pr.author || 'Unknown'}</small>
        `;
        item.onclick = () => showDetailView(pr.id,pr.repo);
        list.appendChild(item);
    });
}

async function showDetailView(prId,repo) {
    currentPr = prId;

    // Fetch PR metadata
    const detailsResp = await fetch(`/api/pr/details?id=${prId}&repo=${repo}`);
    const details = await detailsResp.json();
    console.info('Details received:', details);

    // Fetch PR review text
    const reviewResp = await fetch(`/api/pr/review?id=${prId}`);
    const review = await reviewResp.text();

    document.getElementById('detail-title').textContent = details.title;
    document.getElementById('detail-meta').textContent = `#${details.id} opened on ${details.date || 'Unknown'} by ${details.author || 'Unknown'}`;
    document.getElementById('detail-giturl').textContent = details.prurl;
    document.getElementById('detail-review').textContent = details.review;

    document.getElementById('pr-list').classList.add('d-none');
    document.getElementById('pr-detail').classList.remove('d-none');
}

function showListView() {
    document.getElementById('pr-detail').classList.add('d-none');
    document.getElementById('pr-list').classList.remove('d-none');
}

async function sendFeedback(type) {
    if (!currentPr) {
        alert('No PR selected.');
        return;
    }

    try {
        await fetch('/notification/feedback', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                prNumber: currentPr,
                vote: type // 'up' or 'down'
            })
        });
        alert(`Thanks for your ${type === 'up' ? 'positive' : 'negative'} feedback!`);
        console.info('Feedback received:', type);
    } catch (error) {
        console.error('Failed to send feedback', error);
        alert('Failed to send feedback.');
    }
}

async function submitReviewAction() {
    console.info('Review submitted');
    const selected = document.querySelector('input[name="reviewAction"]:checked');
    if (!selected) {
        alert('Please select an action before submitting.');
        return;
    }

    try {
        await fetch('/notification/decision', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                prNumber: currentPr,
                decision: selected.value // 'Approve' or 'Request Changes'
            })
        });
        alert(`Your decision (${selected.value}) has been submitted!`);
    } catch (error) {
        console.error('Failed to submit decision', error);
        alert('Failed to submit your decision.');
    }
}


function setupWebSocket() {
    console.info('setupWebSocket() entered.')
    const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
    const ws = new WebSocket(`${protocol}://${window.location.host}/ws/prs`);

    ws.onmessage = (event) => {
        const newPr = JSON.parse(event.data);
        console.log("Message received.");
        console.info('event data:', newPr);
        prList.unshift(newPr);
        renderPrList();
    };

    ws.onerror = (err) => console.error('WebSocket error', err);
}

console.info('Initial fetch PRs');
fetchPrs();
console.info('Setting up WebSocket');
setupWebSocket();
    </script>
</body>
</html>
